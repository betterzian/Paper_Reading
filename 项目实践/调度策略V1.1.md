# 一、启发式算法的模型
本模型暂时不考虑性能干扰，只是简单的用资源图替代，同时限定单个节点资源整体分配上限使得性能不会太差。  
## 1 跨集群调度建模
拥有n个集群，对于每个集群$G_i$，都具有一个综合成本$G_i^c$，对于每个任务都有一个运行时间的$T_n$，
则一个任务调度到该集群的预估成本为$G_i^c\times T_i$。并且根据SLO，集群负载等约束，可以将集群
分为可用与不可用两种，对于不可用集群，仅需限定其成本系数为$\infty $即可。
则单个任务非配成本模型可以建立为：$$ C_t = \sum_{i=1}^{n} s_iw_iG_i^cT_t $$
其中：$w_i \in \{1,\infty\}$，对应的集群如果可用为1，不可用为$\infty$。  
$s_i \in \{0,1\}$，选择该集群为1，否则为0。  

## 2 集群内模型建模
### 2.1 成本建模
成本建模可分为在线任务成本与离线任务成本。  
在线任务成本模型与跨集群成本模型类似。则单个在线任务成本模型可以建立为：
$$ C_{n1} = \sum_{i=1}^{n} s_iw_iN_i^cT_t $$
其中：$s_i$为是否选择参数，$s_i \in \{0,1\}$。  
$w_i$表示该节点是否可用，$w_i \in \{1,\infty\}$。  
$N_i^c$为对应$i$节点的运行成本。  
$T_t$为对应任务执行的时间。   
离线任务成本模型具有特殊性，当离线任务使用已分配的在线任务的压缩资源时，成本设定为0，而使用到未分配过的资源时，成本计算则与在线任务相同。假设离线任务资源需求为$n$，持续时间为$t_0$，单个节点cpu核数设定为$N$，因无法跨节点工作，则其选择某个节点的成本为：$$C_{n2}=\frac{nt-\sum_{n=t}^{t+t_0}t}{Nt}N_i^c$$
### 2.2 特性吻合度建模 
假设有n种特性，那么第$i$个任务所携带的特性为矩阵$\mathbb{C_t^i}$=[$C^i_0，C^i_1...C^i_n$]，每个服务器也具有特性矩阵,则第$j$个服务器矩阵为$\mathbb{C_g^j}$=[$C^i_0，C^i_1...C^i_n$]。每个特性分别有个重要性系数$w$，所以存在一个系数矩阵$\mathbb{W}=[W_0，W_1...W_n]$。设定$\wr$为两矩阵$\mathbb{A}，\mathbb{B}$对应元素$A_{ij}\div B_{ij}$运算，$\Vert \mathbb{A}\Vert $为对矩阵$\mathbb{A}$的每个元素$A_{ij}$单独求绝对值运算。 $\alpha$为$1\times n$的值全为1的矩阵。 因此特性吻合度建模为：$$C_c=\mathbb{W}\circ \Vert \left[ \mathbb{C_t^i}-\mathbb{C_g^j}\right]\Vert \wr\mathbb{C_g^j}\alpha^T$$
### 2.3 cpu利用率建模 
cpu利用率建模主要用来限制开新机器，本算法基于未来24小时的cpu使用量预测利用率，单个服务器利用率计算方式为$U_i=\frac{\alpha_r}{\alpha_s}$，同时单个服务器cpu核数设定为$N_i$，设新来的任务需要$n$个核，则总体cpu利用率为：$$U=\frac{\sum_{i=1}^n U_iN_i+n}{\sum_{i=1}^nN_i+New}$$
其中$New \in \{0,N\}$，不新开服务器为0，新开则为N。

## 3 整体建模
综上所述，得出一个单目标优化方案：
$$f(i) = \beta_1C_t+\beta_2(\gamma C_{n1}+(1-\gamma)C_{n2})+\beta_3C_c-\beta_4U$$
其中$\beta_1，\beta_2，\beta_3，\beta_4$均为正数,优化目标为：$i =arg\ minf(i)$

# 二、算法流程
对于到达任务，根据优先级顺序进行调度，高优先级在线任务最先被调度，离线任务最后被调度。  
## 1 选择集群
通过成本建模，以及SLO协议比较，选择成本最低的集群，将任务调度到该集群。  
由于通过成本建模，算法将会总是选择成本低的集群，那么当集群成本不会随着任务量增加而增加或不存在其他随时间变化的情况，则可与预料到任务将总是被调用到成本低的同一个集群中，这样就可以变相的减少集群的开启数量，即被动式集群开关管理。  
## 2 集群内任务分配
集群内调度主要遵循以成本为主，尽量把特性相近的任务与节点组合，但调度之后节点的特性有可能会发生变化，因此在下次调度过程中应当匹配新的特性任务。例如高IO型任务尽量调度到高IO性能的节点中，但调度完之后可能该节点IO性能被占用偏多，已丧失高IO特性，因此下次匹配的任务就不能是高IO型任务了。  
## 3 任务迁移
对于任务的迁移，提出基于任务优先级的的任务迁移策略，决策迁移时机、迁移任务和迁移位置，实时最大化资源利用率。后续因为已经具备此任务一段时间的运行特性，则可以基于强化学习事先生成各个服务器的预测稳定程度，从而可以在迁移过程中将成本与预测的可能迁移成本结合，作为成本参数传递给调度算法，进而开始调度。

# 三、在线任务与离线任务区别
## 1 在线任务
在线任务优先使用节点的实际空余资源，同一个节点间要保障在线任务资源使用量同一时刻相加的共计使用量峰值不能超过集群实际上限。在初次调度时应当保障同一节点间所有在线任务的声称需求量request相加不能超过该节点实际资源量。  
当遇到在线任务资源请求量激增，而服务器资源无法满足时，应当根据优先级与成本衡量后生成的顺序释放低优先级的资源占用，对于离线任务可以直接中断或杀死，对于在线任务应当采取**迁移**措施。
## 2 离线任务
离线任务优先使用在线任务的的压缩空余资源，此时离线任务设定成本应当为0。离线任务的资源量由于不能预估，应当将离线任务认为资源使用量恒为声称需求量request的任务，所以调度时应当确保调度到该离线任务运行时间段内一直具有足够空余资源（实际空余+压缩空余）的节点，以保障离线任务的完成，尽量减少离线任务的中断概率。
当离线任务距离保证时间越近时，应当提高离线任务优先级，直至超过高优先级在线任务，此时离线任务应当保障必须完成。  